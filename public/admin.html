<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Bracket Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* This makes the Clear button appear only on hover */
        .group:hover .group-hover\:opacity-100 { opacity: 1; }
    </style>
</head>
<body class="bg-gray-200">

    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-blue-900 my-6">NFL Bracket Admin Panel</h1>
        <p class="text-center text-gray-600 mb-6">Scoring: 3, 5, 8, 13 (Fibonacci)</p>

        <div id="password-view" class="bg-white p-8 rounded-lg shadow-md text-center">
            <h2 class="text-2xl font-bold mb-4">Enter Admin Password</h2>
            <input type="password" id="password-input" class="w-full max-w-xs mx-auto px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Password">
            <button id="login-btn" class="block w-full max-w-xs mx-auto bg-blue-700 text-white font-bold py-3 mt-4 rounded-lg hover:bg-blue-800 transition-colors">
                Login
            </button>
            <p id="error-message" class="text-red-500 mt-4 h-4"></p>
        </div>

        <div id="admin-content" class="hidden space-y-6"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const ADMIN_PASSWORD = "your-secret-password"; 

        let db, auth, appConfig, tournamentData;
        let actualResults = {};

        const passwordView = document.getElementById('password-view');
        const adminContent = document.getElementById('admin-content');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const errorMessage = document.getElementById('error-message');

        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });

        // HELPER: Revert/Clear a pick locally
        window.clearPick = (gameId) => {
            const radios = document.getElementsByName(gameId);
            radios.forEach(r => r.checked = false);
        };

        async function handleLogin() {
            errorMessage.textContent = "";
            if (passwordInput.value !== ADMIN_PASSWORD) {
                errorMessage.textContent = "Incorrect password.";
                return;
            }
            
            errorMessage.textContent = 'Verifying and Loading Data...';

            try {
                const configModule = await import('./app-config.js?v=' + Date.now());
                appConfig = configModule.appConfig;
                const app = initializeApp(configModule.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                await loadData();
                
                renderAllForms();
                
                passwordView.classList.add('hidden');
                adminContent.classList.remove('hidden');

            } catch (error) {
                console.error("Critical Error:", error);
                errorMessage.textContent = `System Error: ${error.message}`;
            }
        }

        async function loadData() {
            const response = await fetch(`tournament_data.json?v=${Date.now()}`);
            if (!response.ok) throw new Error("Could not find tournament_data.json file.");
            tournamentData = await response.json();

            const resultsDocRef = doc(db, "tournaments", appConfig.TOURNAMENT_ID, "results", "actualResults");
            const docSnap = await getDoc(resultsDocRef);
            if (docSnap.exists()) {
                actualResults = docSnap.data().winners || {};
            }
        }

        function renderAllForms() {
            let html = `
                <div class="flex justify-between items-center bg-white p-6 rounded-lg shadow-md mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Tournament Management</h2>
                        <p class="text-sm text-gray-500">Active ID: ${appConfig.TOURNAMENT_ID}</p>
                    </div>
                    <button id="save-all-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg transition-all">
                        Save All Changes
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            `;

            tournamentData.rounds.forEach(round => {
                html += `
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-600">
                        <h3 class="text-xl font-bold mb-4 text-blue-900">${round.name}</h3>
                        <div class="space-y-4">
                `;

                round.games.forEach(game => {
                    const savedWinner = actualResults[game.id] || "";
                    html += `
                        <div class="p-3 border rounded bg-gray-50 relative group">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Game: ${game.id}</p>
                                <button onclick="clearPick('${game.id}')" class="text-[10px] text-red-500 font-bold hover:underline opacity-0 group-hover:opacity-100 transition-opacity">
                                    CLEAR PICK
                                </button>
                            </div>
                            <div class="flex items-center justify-between gap-4">
                                <label class="flex-1 flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="${game.id}" value="${game.awayTeam}" ${savedWinner === game.awayTeam ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                    <span class="text-sm font-semibold">${game.awayTeam}</span>
                                </label>
                                <span class="text-gray-300 font-bold">vs</span>
                                <label class="flex-1 flex items-center gap-2 cursor-pointer justify-end">
                                    <span class="text-sm font-semibold text-right">${game.homeTeam}</span>
                                    <input type="radio" name="${game.id}" value="${game.homeTeam}" ${savedWinner === game.homeTeam ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                                </label>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });

            html += `</div>`;
            adminContent.innerHTML = html;
            document.getElementById('save-all-btn').addEventListener('click', saveResults);
        }

        async function saveResults() {
            const btn = document.getElementById('save-all-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const newWinners = {};
            tournamentData.rounds.forEach(round => {
                round.games.forEach(game => {
                    const selected = document.querySelector(`input[name="${game.id}"]:checked`);
                    // Only add to the winners map if something is selected
                    if (selected) {
                        newWinners[game.id] = selected.value;
                    }
                });
            });

            try {
                const resultsDocRef = doc(db, "tournaments", appConfig.TOURNAMENT_ID, "results", "actualResults");
                // Using setDoc without merge:true completely overwrites the document, 
                // which effectively removes any "cleared" winners from the database.
                await setDoc(resultsDocRef, { 
                    winners: newWinners, 
                    lastUpdated: new Date().toISOString() 
                });
                alert("Results saved! The leaderboard will now recalculate.");
            } catch (err) {
                alert("Save failed: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save All Changes';
            }
        }
    </script>
</body>
</html>
